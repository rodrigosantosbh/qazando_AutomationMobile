"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __exportStar = (this && this.__exportStar) || function(m, exports) {
    for (var p in m) if (p !== "default" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.command = exports.DEFAULTS = exports.getPrototype = void 0;
const path_1 = __importDefault(require("path"));
const logger_1 = __importDefault(require("@wdio/logger"));
const utils_1 = require("@wdio/utils");
const config_1 = require("@wdio/config");
const command_1 = __importDefault(require("./command"));
exports.command = command_1.default;
const constants_1 = require("./constants");
Object.defineProperty(exports, "DEFAULTS", { enumerable: true, get: function () { return constants_1.DEFAULTS; } });
const utils_2 = require("./utils");
Object.defineProperty(exports, "getPrototype", { enumerable: true, get: function () { return utils_2.getPrototype; } });
const log = logger_1.default('webdriver');
class WebDriver {
    static async newSession(options, modifier, userPrototype = {}, customCommandWrapper) {
        const params = config_1.validateConfig(constants_1.DEFAULTS, options);
        if (!options.logLevels || !options.logLevels.webdriver) {
            logger_1.default.setLevel('webdriver', params.logLevel);
        }
        /**
         * Store all log events in a file
         */
        if (params.outputDir && !process.env.WDIO_LOG_PATH) {
            process.env.WDIO_LOG_PATH = path_1.default.join(params.outputDir, 'wdio.log');
        }
        log.info('Initiate new session using the WebDriver protocol');
        /**
         * if the server responded with direct connect information, update the
         * params to speak directly to the appium host instead of a load
         * balancer (see https://github.com/appium/python-client#direct-connect-urls
         * for example). But only do this if the user has enabled this
         * behavior in the first place.
         */
        const { directConnectProtocol, directConnectHost, directConnectPort, directConnectPath } = params;
        if (directConnectProtocol && directConnectHost && directConnectPort && (directConnectPath || directConnectPath === '')) {
            log.info('Found direct connect information in new session response. ' +
                `Will connect to server at ${directConnectProtocol}://${directConnectHost}:${directConnectPort}/${directConnectPath}`);
            params.protocol = directConnectProtocol;
            params.hostname = directConnectHost;
            params.port = directConnectPort;
            params.path = directConnectPath;
        }
        const requestedCapabilities = { ...params.capabilities };
        const { sessionId, capabilities } = await utils_2.startWebDriverSession(params);
        const environment = utils_1.sessionEnvironmentDetector({ capabilities, requestedCapabilities });
        const environmentPrototype = utils_2.getEnvironmentVars(environment);
        const protocolCommands = utils_2.getPrototype(environment);
        const prototype = { ...protocolCommands, ...environmentPrototype, ...userPrototype };
        const monad = utils_1.webdriverMonad({ ...params, requestedCapabilities }, modifier, prototype);
        return monad(sessionId, customCommandWrapper);
    }
    /**
     * allows user to attach to existing sessions
     */
    static attachToSession(options, modifier, userPrototype = {}, commandWrapper) {
        if (!options || typeof options.sessionId !== 'string') {
            throw new Error('sessionId is required to attach to existing session');
        }
        // logLevel can be undefined in watch mode when SIGINT is called
        if (options.logLevel) {
            logger_1.default.setLevel('webdriver', options.logLevel);
        }
        options.capabilities = options.capabilities || {};
        options.isW3C = options.isW3C === false ? false : true;
        const environmentPrototype = utils_2.getEnvironmentVars(options);
        const protocolCommands = utils_2.getPrototype(options);
        const prototype = { ...protocolCommands, ...environmentPrototype, ...userPrototype };
        const monad = utils_1.webdriverMonad(options, modifier, prototype);
        return monad(options.sessionId, commandWrapper);
    }
    /**
     * Changes The instance session id and browser capabilities for the new session
     * directly into the passed in browser object
     *
     * @param   {Object} instance  the object we get from a new browser session.
     * @returns {string}           the new session id of the browser
    */
    static async reloadSession(instance) {
        const params = {
            ...instance.options,
            capabilities: instance.requestedCapabilities
        };
        const { sessionId, capabilities } = await utils_2.startWebDriverSession(params);
        instance.sessionId = sessionId;
        instance.capabilities = capabilities;
        return sessionId;
    }
    static get WebDriver() {
        return WebDriver;
    }
}
exports.default = WebDriver;
__exportStar(require("./types"), exports);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLGdEQUF1QjtBQUN2QiwwREFBaUM7QUFFakMsdUNBQXdFO0FBQ3hFLHlDQUE2QztBQUc3Qyx3REFBK0I7QUFtSEUsa0JBbkgxQixpQkFBTyxDQW1IMEI7QUFsSHhDLDJDQUFzQztBQWtIZix5RkFsSGQsb0JBQVEsT0FrSGM7QUFqSC9CLG1DQUFpRjtBQWlIeEUsNkZBakh1QixvQkFBWSxPQWlIdkI7QUE5R3JCLE1BQU0sR0FBRyxHQUFHLGdCQUFNLENBQUMsV0FBVyxDQUFDLENBQUE7QUFFL0IsTUFBcUIsU0FBUztJQUMxQixNQUFNLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FDbkIsT0FBMEIsRUFDMUIsUUFBa0MsRUFDbEMsYUFBYSxHQUFHLEVBQUUsRUFDbEIsb0JBQThDO1FBRTlDLE1BQU0sTUFBTSxHQUFHLHVCQUFjLENBQUMsb0JBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQTtRQUVoRCxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFO1lBQ3BELGdCQUFNLENBQUMsUUFBUSxDQUFDLFdBQVcsRUFBRSxNQUFNLENBQUMsUUFBUyxDQUFDLENBQUE7U0FDakQ7UUFFRDs7V0FFRztRQUNILElBQUksTUFBTSxDQUFDLFNBQVMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFO1lBQ2hELE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxHQUFHLGNBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxVQUFVLENBQUMsQ0FBQTtTQUN0RTtRQUVELEdBQUcsQ0FBQyxJQUFJLENBQUMsbURBQW1ELENBQUMsQ0FBQTtRQUU3RDs7Ozs7O1dBTUc7UUFDSCxNQUFNLEVBQUUscUJBQXFCLEVBQUUsaUJB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